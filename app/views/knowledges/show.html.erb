<div class="container">
  <h3><%= @knowledge.title %></h3>
  <small>--<%= @knowledge.subtitle %></small>
  <hr>
  <div class="rate">
    <div class="raty" data-score="<%= @knowledge.find_score(current_user).try(:score) || 0 %>" data-score-url="<%= rate_knowledge_path(@knowledge) %>"></div><span class="average-score"><%= @knowledge.average_score %></span>
  </div>

    <%= render "like" %>
    <%= render "star" %>
    <%= render "follow" %>
    <%= render "learn" %>
    <%= render "buy" %>

  <hr>
  <% @knowledge.photos.each do |photo| %>
    <%= image_tag(photo.image.thumb.url) %>
  <% end %>
  <hr>
  <p>产品介绍: <br><%= sanitize @knowledge.description %> </p>
  <p>适宜人群: <br><%= sanitize @knowledge.appropriate %> </p>
  <p>订阅须知: <br><%= sanitize @knowledge.notice %> </p>
  <hr>
  <div class="section-review">
    <%= link_to("写评测", new_knowledge_review_path(@knowledge), class: "btn btn-default") %>
    <hr>
    <% @knowledge.reviews.each do |review| %>
      <div class="panel panel-default">
        <div class="panel-heading">
          <%= review.user.username %> 发表评测：《<%= link_to(review.title, knowledge_review_path(@knowledge, review)) %>》
          <a href="#">
            <i class="fa fa-heart" aria-hidden="true"></i><span>(10)</span>
          </a> <!-- 待补充 -->
        </div>
        <div class="panel-body">
          <% if current_user && review.user == current_user %>
            <%= link_to("edit", edit_knowledge_review_path(@knowledge, review), class: "btn btn-warning btn-xs pull-right") %>
            <%= link_to("delete", knowledge_review_path(@knowledge, review), method: :delete, data: {:confirm => "删除后无法恢复，确定要删除吗？"}, class: "btn btn-danger btn-xs pull-right") %>
          <% end %>
          <%= simple_format(review.content) %>
        </div>
      </div>
    <% end -%>
  </div>
</div>

<%= content_for :page_javascript do %>
  <script>
   $(".raty").raty({
     path: '/images/',
     score: function() { return $(this).data('score'); },
     click: function(score) {
       var that = this;
       $.ajax({
         url: $(this).data("score-url"),
         method: "POST",
         data: { score: score },
         dataType: "json",
         success: function(data){
           $(that).closest(".rate").find(".average-score").html( data["average_score"] );
         }
       })
     }
   });
  </script>
<% end %>
